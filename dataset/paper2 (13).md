# Обзор методов сбора информации для отладки приложений, использующихся в системах хранения данных

Ключевые слова: сбор информации для отладки, системы хранения данных, отладка приложений, журналирование, профилирование, трассировка

## Аннотация
В данной статье были рассмотрены методы сбора отладочной информации и основные принципы их работы. Проведен сравнительный анализ данных методов. Рассмотрены проблемы актуальности собираемой информации, а также влияния существующих решений на производительность систем, в которых они исполняются. Опираясь на данные, полученные при обзоре существующих решений, был предложен метод сбора отладочной информации, основанный на сохранении данных о работе программы в оперативную память и печать собранной информации в log-файл лишь в случае ошибки в ходе работы программы. 
## Введение
С каждым днём растёт количество цифровой информации, необходимой для хранения. В связи с этим возникает потребность в разработке новых или улучшении уже существующих систем хранения данных. 
Это влечёт за собой необходимость выбрать способ реализации сбора отладочной информации для новой или улучшенной системы. Однако формирование качественных требований к такому методу затруднительно.
Целью данной статьи является предложение метода сбора отладочной информации для использования в системах хранения данных, удовлетворяющего сформированным качественным требованиям.
Поставлены следующие задачи:
1. Рассмотреть принципы работы существующих методов сбора отладочной информации, используемых в приложениях для работы с системами хранения данных.
2. Провести сравнительный анализ методов сбора отладочной информации.
3. Сделать выводы об эффективности и актуальности собираемой отладочной информации.
4. Предложить эффективный метод для возможной дальнейшей реализации.
Объект исследования: методы сбора отладочной информации, использующиеся в приложениях для работы с системами хранения данных.
Предметом исследования является актуальность собранной отладочной информации, а также влияние сбора отладочной информации на производительность и на количество используемой приложением памяти.

## Обзор предметной области

Для обзора отбирались статьи, в которых рассматривались такие методы сбора отладочной информации как логирование, профилирование, трассировка, а также предлагалось улучшение перечисленных методов.
### Методика отладки на основе воспроизведения трассы исполнения приложения на языке JAVA 
В статье [1] описывается методика отладки дефектов, возникающих в ходе работы приложения, путем создания системы, которая позволяет сохранять поток управления приложения (трассу) в условиях, где дефект повторяется, и впоследствии восстанавливает состояние системы на момент появления дефекта в окружении разработчика. В состав такой системы входят такие инструменты как: статистический анализатор кода, модуль логирования, модуль отладки. Трасса, которую описывает автор статьи, представляет собой последовательность вызовов методов, создания объектов, операций выделения памяти. Основной причиной выбора статьи [1] является то, что она первой встречается при знакомстве с методиками отладки. Достоинством системы, рассмотренной в статье [1] можно назвать отсутствие выделения большого количества оперативной памяти для работы системы. Одним из главных недостатков является привязанность к языку JAVA, так как некоторые модули программы подключаются с помощью специальных интерфейсов напрямую к Java Virtual Machine. 
### Инструментарий надежного хранения данных
В статье [2] рассмотрены подходы к созданию программного обеспечения для функционирования и отладки систем надежного хранения данных, а также показаны подходы к неинвазивному профилированию динамических библиотек в Linux. Опиывается реализация механизма перехвата вызовов, рассматриваются также основные достоинства журналирования и проблемы, возникающие при анализе файлов журнала (log-files). Причиной выбора данного аналога стало наибольшая приближенность статьи [2] к теме исследования, так как в ней рассматривается отладка непосредственно в системах хранения данных. Достоинствами данного метода можно назвать описания процесса анализа файлов журналов (log-файлов), а также подробное описание процесса перехвата вызовов, что может быть полезно при реализации профилирования. К недостаткам можно отнести отсутствие описания использования перехвата вызовов для реализации трассировки.
### Efficient log filter
В статье [3] решается такая задача журналирования, как фильтрация происходящих событий во время выполнения программы. Также предлагается эффективный способ фильтрации журнала. Журналирование является необходимой функцией для системы сбора отладочной информации, подробный обзор этой функции в статье [3] является главным достоинством и послужил причиной выбора данного аналога. Недостатком метода является то, что при автоматической фильрации событий, записываемых в log-файл, существует вероятность пропустить информацию, необходимую для дальнейшего анализа.
### Трассировка и самолечение в POSIX-системах
В работе [4] предлагается методика самолечения POSIX-систем, основанная на использовании механизма трассировки. Большое внимание уделяется обзору механизма трассировки и требований к нему. Данный аналог наиболее подробно описывает функцию и реализацию трассировки, что является достоинством этого метода. Из недостатков можно отметить привязку конкретно к POSIX-системам.
### Метод автоматизированного поиска программных ошибок в алгоритмах обработки сложноструктурированных данных
В статье [5] рассматривается разработанный автором метод поиска программных ошибок в программном обеспечении при отсутствии исходного кода. Метод основан на стрессовом тестировании совместно с автоматической трассировкой программного обеспечения. При этом наборы текстовых данных могут формироваться статистически или динамически на основе результатов тестирования. Данный метод первым встречается при знакомстве с областью автоматического поиска программных ошибок. Большим достоинством данной статьи является поэтапное текстовое описание алгоритма, а также большое количество теоретических выкладок. Недостатком же является отсутствие описания результативности метода, что не позволяет в полной мере оценить его эффективность.

### Критерии сравнения аналогов
Поскольку целью работы является предложение метода сбора отладочной информации, то необходимо оценивать влияние предложенного метода на производительность и на количество потребляемой программой памяти, так как эти характеристики являются одними из ключевых для любой программмы. Так же целью является разработка метода именно для систем хранения данных, которые совершают большое количество операций ввода/вывода, в связи с чем повышается количество информации, которую предложенный метод будет фильтровать. Именно из-за этогобыл выбран такой критерий как "Актуальность сохраненной информации"

*Влияние на производительность программы*
Важно определить, насколько понизится производительность программы после внедрения в нее выбранного метода сбора отладочной информации. В случае значительной потери производительности метод не может считаться эффективным.

*Анализ потребляемой памяти*
Не менее важной характеристикой является количество памяти, которое потребляет выбранный метод сбора информации. Метод также не может считаться эффективным, если происходит значительное увеличение памяти, необходимой для работы программы. Исходя из экспериментов, проведенных с использованием системы z/OS и языка программирования HLASM, есть возможность собирать актуальную для отладки информацию, используя при этом лишь 1-2 Мегабайта оперативной памяти.

*Актуальность сохраненной информации*
Данные, полученные в ходе работы системы сбора отладочной информации должны быть актуальны. На основе полученных данных необходимо сохранять лишь информацию, которая может быть полезна при анализе ошибки. 
Результаты сравнения рассмотренных программных средств по перечисленным критериям приведены в таблице 1.

Таблица 1 - Сравнение аналогов

|                       |Методика отладки на основе воспроизведения трассы исполнения приложения на языке JAVA | Инструментарий надежного хранения данных | Efficient log filter | Трассировка и самолечение в POSIX-системах |Метод автоматизированного поиска программных ошибок в алгоритмах обработки сложноструктурированных данных|
| --------------------- | ---------------------- | ---------------------- | ------------------ | -------------- |----------|
| Влияние на производительность программы     | Не описано                   |Не описано                   | Описано               |  Не описано         | Не описано|
| Анализ потребляемой памяти | Описана проблема выделения большого количества оперативной памяти в существующих решениях.            | Не произведен                 | Указано, что метод выделяет дополнительную память, но не указан размер             | Не произведен      | Не указано |
| Актуальность сохраненной информации   | 5 баллов - перечислены все данные, которые будут сохраняться, а также объяснена их актуальность                    | 4 балла -  описана информация, которую будет сохранять профилировщик, а так же рассмотрены подходы к уменьшению информации в log-файлах                | 5 баллов - описывается актуальность всей фильтруемой информации               | 2 балла - в большей степени описывается реализация трассировки, чем актуальность сохраняемой информации          | 3 балла - система автоматически находит программные ошибки, однако для наибольшей актуальности необходимо также сохранять информацию о том, что послужило причиной некорректного поведения программы. 


Проведенный анализ показал, что существует большое количество методов улучшения сбора отладочной информации. Наиболее популярными являются: журналирование, профилирование и трассировка. Однако во многих исследованиях не указаны такие ключевые характеристики как влияние методов на производительность программы и анализ потребляемой памяти. Таким образом в данном исследовании необходимо также уделить внимание ранее перечисленным ключевым характеристикам.
Также проблемой является привязанность многих существующих решений к конкретному языку программирования или архитектуре.

## Выбор метода решения
Для соответствия выбранным критериям решение должно представлять собой предложение реализации программного продукта, исполняющего следующие функции:
1. Ведение журнала работы приложения. Это позволит сохранять лишь актуальную информацию о работе системы.
2. Трассировка стека вызовов.
3. Фиксация времени работы различных методов приложения.

Необходимо произвести анализ производительности приложения для работы с системами хранения данных, а также на количество используемой памяти. 
Поскольку производительность системы хранения данных, а следовательно и приложения для работы с такой системой, является одним из важнейших критериев, то важным шагом будет предложение метода, который позволил бы минимизировать время, затрачиваемое на работу такого приложения.
Уменьшения времени работы можно добиться путем увеличения количества запросов к оперативной памяти и уменьшения числа запросов к файловой системе. Это связано с тем, что время доступа к оперативной памяти существенно меньше времени доступа к внешней памяти.
Также важно оценивать необходимость печати собранной отладочной информации. Log файл должен создаваться лишь в случае некорректного поведения приложения для работы с системой хранения данных. В случае корректного завершения работы приложения log файл создаваться не будет. 
Еще одним важным свойством решения должна быть непривязанность к определенной архитектуре или языку программирования.


## Описание метода решения
На основании перечисленных в главе **Обзор предметной области** критериев, а также функций приложения, описанных в предыдущей главе, предлагается следующее решение.
Приложение будет генерировать log-файл работы системы хранения данных, в который будут записываться следующие данные:
1. Дампы памяти основных структур данных и переменных до и после их изменения
2. Адреса и размеры выделяемой и освобождаемой памяти
3. Для вызываемых функций: входные параметры, а также возвращаемые значения и время работы. 
4. Стек вызовов для основных функций. Данную информацию стоит выводить только в случае, если будет указан специальный параметр запуска, так как обратная трассировка может существенно повлиять на производительность.

Для уменьшения количества запросов к файловой системе вся информация будет записываться в специально выделенную для этого память. Основным преимуществом такой реализации будет уменьшение времени, затрачиваемого на доступ к внешней памяти.
Основным же недостатком является угроза переполнения оперативной памяти в случае длительного времени работы приложения. Для избежания данной проблемы будет выделяться память лишь фиксированного размера, кратного числу строк log файла.
Количество строк log-файла будет задаваться пользователем или определяться значением по умолчанию. Такой подход позволит контролировать объем памяти, используемой дополнительно.
В случае, если за время работы приложения необходимо сохранить число строк, которое больше фиксированного количества, то каждая следующая строка будет заменять самую первую из записанных.
В ситуации, когда приложение, для которого осуществляется сбор отладочной информации, завершит свою работу аварийно или с некорректным результатом, будет сгенерирован log-файл, в который будет напечатана вся информация, сохраненная в оперативной памяти за время работы программы.

## Заключение
В рамках данного исследования был проведен сравнительный анализ методов сбора отладочной информации, а также рассмотрены основные принципы их работы. Также существующие решения сравнивались по следующим критериям:
 1. Влияние на производительность программы
 2. Анализ потребляемой памяти
 3. Актуальность сохраненной информации

Сделаны выводы об эффективности и актуальности существуюших решений.
На основании обзора существующих методов было предложено решение, непривязанное к определенной архитектуре или языку программирования. 
Предложенный метод сбора отладочной информации оказывает меньшее влияние на скорость работы приложения, так как вся информация собирается в оперативной памяти и печатается в файл только в случае ошибки в ходе работы приложения.
Количество памяти, необходимое для предложенного решения определяется пользователем или устанавливается значением по умолчанию. 
Основной информацией, подлежащей сохранению в ходе работы программы является: основные структуры данных; информация о выделяемой и освобождаемой памяти; входные параметры, а также возвращаемые значения и время работы функций; стек вызовов для основных функций.