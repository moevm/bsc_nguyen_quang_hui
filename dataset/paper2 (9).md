# Разработка программы 3D визуализации нефтегазоносных скважин

Ключевые слова: скважина, пласты земли, газоводяной контакт, интерполяционный сплайн, кроссплатформенность

# Aннотация
Целью данной статьи является разработка приложения для визуализации нефтегазовых скважин, предназначенного для ускорения работы диспетчеров.
В ходе работы произведен обзор аналогов, выявлены их достоинства и недостатки. Также разработаны методы отображения скважин и их частей, пластов земли и газоводяного контакта.

# Введение
Природный газ широко применяется в качестве горючего в жилых домах, топлива для автомобилей, котельных, ТЭЦ, поэтому важно следить за состоянием факторов, которые могут повлиять на его качество. Такими факторами являются уровни пластов земли и газоводяного контакта. Также немаловажными факторами, от которых также зависит добываемый объем газа,  являются отклонение скважин от оси аппликат и координаты начала и окончания частей скважин. Однако в данный момент не существует универсального приложения для исследования и, поэтому диспетчерам приходится тратить много времени на анализ. Таким образом, целью работы является разработка приложения визуализации нефтегазовых скважин, которое позволит ускорить и упростить работу диспетчеров. Объектом исследования данной работы являются процессы, происходящие в нефтегазовых скважинах, пластах земли, газоводяном контакте. Предметом исследования  являются способы визуализации нефтегазовых скважин, пластов земли и газоводяного контакта.

В данной работе поставлены следующие задачи:
1) Разработать дружественный интерфейс пользователя;
2) Разработать метод отображения скважин;
3) Разработать метод отображения пластов земли и газоводяного контакта;
4) Oбеспечить кроссплатформенность приложения.

# Обзор предметной области
Отбор аналогов производился согласно функциональным требованиям к системе. Под функциональными требованиям к системе подразумеваются задачи, которые необходимо решать диспетчерам: исследование стволов скважин, пластов земли и газоводяного контакта. Также под функциональными требованиями подразумевается кроссплатформенность, благодаря которой у пользователя нет необходимости переходить на другую операционную систему. Ниже приведено сравнение существующих систем анализа состояния скважин, уровня пластов земли, газоводяного контакта. Выбирались системы, максимально близко удовлетворяющеие перечисленным выше функциональным требованиям.

**Антереал** - информационная система, предназначенная для управления данными бурения скважин, визуализирует данные по скважинам в 3D. Данная система позволяет анализировать стволы скважин с учетом их типа, траектории, а также координат начала и окончания. Однако, система не предоставляет возможность анализа слоев земли и уровня газоводяного контакта. Запускается только под Windows.[1]

**LogPWin-AIMS** - данное программное обеспечение направлено преимущественно на исследование пластов земли. Позволяет исследовать как геометрические размеры и положение пластов, так и такие физическиие и химические свойства пласта как глиностость, пористость, химеческий состав пород. Не позволяет анализировать стволы скважин. Запускается только под Windows.[3]

**Geosoft Target** - данное программное обеспечение позволяет анализировать геологические, геохимические и геофизичиские данные пластов земли, координаты забоя и траекторию скважин. Существует возможность просмотра как в различных 2D проекциях, так и в 3D. Запускается только под Windows.[2]

**Инструмент для визуализации плана бурения Optimine** - программное обеспечение для визуализации стволов скважин, с учетом их типа, траектории, координат начала и окончания. Система позволяет анализировать пласты земли, но не предоставляет возможность простотра данных по газоводяному контакту. Приложение может запускаться в различных операционных системах.[6]

**Prime** - программное обеспечение для анализа скважин, а именно их траектктории, просмотра профиля в 3D и различных 2D проекциях. Также система позволяет анализировать пласты земли, но не предоставляет возможность анализа газоводяного контакта.[4] Приложение является кроссплатформенным.[5]

В качестве **критериев сравнения** были выбраны:

1. **Кроссплатформенность** - позволяет обеспечить независимость разрабатываемого приложения от операционной системы.
2. **Возможность анализа пластов земли и газоводяного контакта** - возможность исследовать уровни и состояния пластов земли и газоводяного контакта.
3. **Возможность анализа стволов скважин**  - возможность исследовать тип, длину, глубину, диаметр и отклонение скважин от оси аппликат в данной точке.



|                                                                       | Антереал     | LogPWin-AIMS   | Geosoft Target | Инструмент для визуализации плана бурения Optimine| Prime |
| -------------------------------------------------------------------   | :-----------:| ---------------| ---------------| --------------------------------------------------|-------|       
| Кроссплатформенность                                                  | Нет          |   Нет          | Нет            | Да                                                |  Да  |    
| Возможность анализа пластов земли и газоводяного контакта             | Нет          |   Да           | Да             | Частично (не предоставляет возможность анализа газоводяного контакта)|  Частично (не предоставляет возможность анализа газоводяного контакта)   |
| Возможность анализа стволов скважин                                   | Да           |   Нет          | Да             | Да                                                |   Да   |

<p align=center>Таблица 1 - сравнение аналогов</p>

# Выбор метода решения

В результате обзора аналогов было выяснено, что решение должно представлять программный продукт, который позволит анализировать как стволы скважин и их части, так и уровни пластов земли и газоводяного контакта. Также продукт должен быть кроссплатформеным, чтобы работоспособность разрабатываемого приложения не зависила от операцонной системы.
Также необходимо обеспечить:
* Приемлемую скорость работы приложения. Объем обрабатываемых данных, по которым строятся скважины и пласты земли, может быть очень большим, поэтому необходимо обрабатывать данные оптимальным по времени способом. В среднем скорость работы должна быть не меньше 50 fps.
* Небольшой расход памяти. Так как 3D модели скважин строятся по большому количеству точек, то они могут занимать много места в оперативной памяти, поэтому при построении необходимо упрощать 3D модели. В оперативной памяти приложение должно занимать не больше 500 Мб.
* Приемлемая скорость загрузки приложения. Время начальной обработки данных не должно превышать 3 секунд.

# Решение поставленных задач
# Разработка дружественного интерфейса пользователя
При управлении сложными техническими объектами в масштабе предприятия с помощью компьютерных систем диспетчер общается с этими объектами посредством человеко-машинного интерфейса. Также, современный диалог должен отвечать наследующие вопросы: какая информация, когда, в какой форме и почему должна передаваться от одного компонента системы к другому[12]? Основная информация, которая может потребоваться диспетчеру: тип скважины, вид скважин относительно друг друга, длина, отклонение от оси аппликат, расстояние до газоводяного контакта, тип части скважины в данной точке. Также диспетчеру может потребоваться вид пластов земли и газоводяного контакта, относительно скважин, тип пласта, кровля и подошва пласта(значение по оси ординат в верхней и нижней точке соответственно). Таким образом, основную часть экрана (порядка 85%) должно занимать изображение куста скважин. Диспетчер получает нужную ему информацию путем наведения мыши на интересующий его объект. Остальная часть экрана отводится под элементы управления, предназначенные для упрощения и ускорения анализа: кнопки изменения прозрачности и отключения пластов земли и газоводяного контакта, а также просмотра вида сверху, сбоку, спереди.

# Разработка метода отображения скважин
Скважины строятся по набору точек, полученных с помощью робота, который осуществляет измерение координат скважин в некоторых ее точках. Для изображения скважины необходимо интерполировать точки, однако необходимо контролировать суммарное количество точек при интерполяции, чтобы не столкнуться с проблемами большого потребления оперативной памяти программой, большим временем начальной обработки данных и небольшим количеством кадров в секунду (fps). Графики зависимости времени начальной обработки данных, fps и потребляемой оперативной памяти приведены ниже:

![](https://github.com/moevm/scientific_writing-2019/blob/6383_MiheevaEE/6383_Miheeva_EE/resourses/fps.png)<div align="center">Рисунок 1 - зависимость fps от суммарного количества точек</div>




![](https://github.com/moevm/scientific_writing-2019/blob/6383_MiheevaEE/6383_Miheeva_EE/resourses/loadTime.png)
<p align="center">Рисунок 2 - зависимость времени начальной обработки данных от суммарного количества точек</p>

![](https://github.com/moevm/scientific_writing-2019/blob/6383_MiheevaEE/6383_Miheeva_EE/resourses/memory.png)
<p align="center">Рисунок 3 - зависимость потребляемой оперативной памяти от суммарного количества точек</p>

Из вышеприведенных графиков следует, что суммарное количество точек во всех скважинах должно быть не более 3000. Существует несколько видов интерполяционных сплайнов, рассмотрим некоторые из них:

1) Линейный сплайн.

Уравнение прямой имеет вид:

![](https://github.com/moevm/scientific_writing-2019/blob/6383_MiheevaEE/6383_Miheeva_EE/resourses/lin_spl.png)

Варьируя x, y или z в диапазоне от начального до конечного значения соответствующей координаты, получим точки, по которым строится скважина.
Однако он не удовлетворяет требованиям непрерывности первой и второй производной[9], поэтому при использовании линейной интерполяции скважина перестанет быть гладкой, следовательно, данный метод не является подходящим для данной задачи.

2) Многочлен Лагранжа.

Функция класса многочленов одной переменной, проходящая через n точек, степени не более n-1, существует только одна независимо от способа еѐ получения[7].
Определение интерполяционного многочлена Лагранжа приводится в виде формулы:

![](https://github.com/moevm/scientific_writing-2019/blob/6383_MiheevaEE/6383_Miheeva_EE/resourses/lagr.png)

Таким образом, получаем, что скважина является полиномом степени не больше n-1, где n - количество точек. Однако у многочлена Лагранжа есть существенный недостаток: данный метод не является вычислительно устойчивым, следовательно, при больших степенях значения многочлена Лагранжа будут сильно отличаться от истинных значений функции. В качестве примера возьмем функцию f(x) = sin(x) и расчитаем максимальное отклонение функции, полученной в результате интерполирования при различном количестве точек интерполяции:

![](https://github.com/moevm/scientific_writing-2019/blob/023b7413bd5997847f5109c362237643d0c79d48/6383_Miheeva_EE/resourses/deviation.png)
<p align="center">Рисунок 4 - максимальное отклонение от истинного значения функции в зависимости от количества точек интерполирования</p>

Из графика выше следует, что в связи с погреношностью вычислений компьютера при большом количестве точек интерполирования (больше 20) значения интерполированной функции сильно отличается от истинных значений. Так как количество точек, измеренных роботом, на одной скважине не меньше 200, то данный метод не является подходящим для решаемой задачи. Рассмотрим следующий метод интерполяции.

3) Кривые Безье.

Кубическая кривая Безье строится по четырём точкам P<sub>0</sub>,P<sub>1</sub>, P<sub>2</sub>, P<sub>3</sub>
Кривая Безье задается формулой:

B(t) = (1 − t)<sup>3</sup>P<sub>0</sub> + 3t(1 − t)<sup>2</sup>P<sub>1</sub>+3t<sup>2</sup>(1-t)P<sub>2</sub>+t<sup>3</sup>P<sub>3</sub>.
Точки P<sub>0</sub> и P<sub>3</sub> являются концами кубической кривой Безье, точки P<sub>1</sub> и P<sub>2</sub> называют контрольными. Кривая Безье не проходит через контрольные точки, но они влияют на её форму.
Если разбивать имеющиеся точки скважины на группы по 4 элемента, то полученная кривая будет проходить не через все точки, так как первая и вторая точки являются контрольными. Также в местах склейки сегментов полученная кривая будет разрывна по второй производной, следовательно, полученная скважина не будет достаточно гладкой. Следовательно, необходимо:
* Использовать в качестве концевых точек P<sub>i</sub> и P<sub>i-1</sub>, где P<sub>i</sub> и P<sub>i-1</sub> - измеренные точки скважины, а контрольные точки вычислять самостоятельно.
* Обеспечить непрерывность по второй производной в местах склейки сегментов

Выполним расчет первой и второй производных кривой Безье B(t):

B'(t) = 3[(t-1)<sup>2</sup>P<sub>0</sub> + (1-3t)(1 − t)P<sub>1</sub>+t(2-3t)P<sub>2</sub>+t<sup>2</sup>P<sub>3</sub>]

B''(t) = 6[(1 − t)<sup>2</sup>P<sub>0</sub> + (2-3t)P<sub>1</sub>+t(1-3t)P<sub>2</sub>+tP<sub>3</sub>]

Подставив значения t = 0 и t = 1 получим значения первой и второй производной на концах сегментов:

B'(0) = 3(P<sub>1</sub>-P<sub>0</sub>)

B'(1) = 3(P<sub>3</sub>-P<sub>2</sub>)

B''(0) = 6(P<sub>0</sub>-2P<sub>1</sub>+2P<sub>2</sub>)

B''(1) = 6(P<sub>1</sub>-2P<sub>2</sub>+2P<sub>3</sub>)

Обеспечим равенство первых и вторых производных в местах склейки:

B'<sub>i-1</sub>(1) = B'<sub>i-</sub>(0)

B''<sub>i-1</sub>(1) = B''<sub>i-</sub>(0)

Установим краевые условия:

B''<sub>0</sub>(0) = 0

B''<sub>n-1</sub>(1) = 0, откуда получаем:

2P<sub>2,0</sub>-P<sub>1,0</sub>-P<sub>0,0</sub> = 0

2P<sub>2,n-1</sub>-P<sub>1,n-1</sub>-P<sub>0,n-1</sub> = 0, где первый индекс - номер точки, второй индекс - номер сегмента.

Получаем систему из 2n линейных уравнений:

![](https://github.com/moevm/scientific_writing-2019/blob/6383_MiheevaEE/6383_Miheeva_EE/resourses/bezier.png)

Заметим, что матрица системы является четырехдиагональной, следовательно, ее можно решить за время O(n) методом Гаусса с выбором максимального по модулю разрешающего элемента в столбце. [8]
# Разработка метода отображения пластов земли и газоводяного контакта
Для отображения пластов земли и газоводяного контакта используется множество заранее измеренных роботом точек. Для отображения подходит mesh или также полигональная сетка - совокупность вершин и треугольников, которые определяют форму объекта. Для построения mesh необходимо рассчитать массив треугольников, который задает порядок соединения точек. Данную проблему решает алгоритм триангуляции Делоне:

1) Строится выпуклая оболочка данной системы точек {P<sub>i</sub>}<sup>N</sup><sub>i=1</sub>. Предполагается, что никакие n точек данной системы не лежат на одной гиперплоскости. В предположении, что никакие n + 1 точек не лежат на одной сфере, триангуляция Делоне строится единственным способом.
2) Выбирается n точек из данного семейства таких, что соответствующий (n− 1)-мерный симплекс G<sub>0</sub> с вершинами в этих точках лежит на границе выпуклой оболочки.
3) Ориентируем этот симплекс относительно внешней нормали к границе выпуклой оболочки conv({P<sub>i</sub>}). Находим точку из семейства {P<sub>i</sub>} такую, что описанный шар вокруг полученного симплекса не содержит других точек из {P<sub>i</sub>}.
4) Выбираем произвольную грань построенного симплекса, отличную от G<sub>0</sub>.
Ориентируем эту грань нормалью, направленной в сторону уже построенного симплекса, содержащего эту грань. Будем строить два списка (n−1)-мерных граней: F<sub>0</sub> и F<sub>1</sub>. F<sub>0</sub> будет содержать те грани, для которых определены тетраэдры по обе ее стороны, или если по одну ее сторону определен тетраэдр, а по другую — неограниченная область. На первом шаге в F<sub>0</sub> записана грань G<sub>0</sub>, а F<sub>1</sub> = ∅.
5) Для каждой грани e из F<sub>0</sub> рассмотрим семейство шаров, содержащих ее грани. Все их центры расположены на прямой, проходящей через центр описанной около этой грани (n−2)-мерной сферы. Находим точку нашего набора,
принадлежащую границе одного из шаров семейства, который в свою очередь не содержит внутри себя других точек, причем эту точку ищем только среди точек, лежащих в полупространстве, куда указывает нормаль к e. Если такой точки нет, то просто такую грань перемещаем из F<sub>0</sub> в F<sub>1</sub>. Если точка найдется, то строим новый тетраэдр, и его грани, кроме текущей e, помещаем в F<sub>0</sub>, а саму e перемещаем в F<sub>1</sub>. Каждую новую грань ориентируем внешней нормалью тетраэдра.
6) Далее процесс повторяется, пока все грани из F<sub>0</sub> не перейдут в список F<sub>1</sub>. [10]
Таким образом, получен массив треугольников, следовательно, теперь достаточно данных, чтобы строить mesh.

# Обеспечение кроссплатформенности приложения
Для того, чтобы разрабатываемое программное обеспечение не зависило от операционной системы, что избавляет пользователя от необходимости переустановки или использовании второй или виртуальной операционной системы. Для этого для разработки используем платформу для 3D разработки Unity 3D, которая использует технологию IL2CPP для переноса .NET байт-кода в язык C++, который преобразуется кросс-компилятором Emscripten в язык WebAssembly[13], который поддерживают большинство современных браузеров[11]

# Заключение
Таким образом, в ходе работы были обозначены критерии, которым должно удовлетворять разрабатываемое приложение:
* Возможность анализа стволов скважин
* Возможность анализа пластов земли и газоводяного контакта
* Кроссплатформенность
* Время начальной обработки данных не должно превышать 3 с
* Программа должна занимать в оперативной памяти не более 500 Мб
* Количество кадров в секунду должно быть не менее 50 fps.
Также были получены ответы на поставленные задачи. Так, для обеспечения дружественного интерфейса основную часть экрана должно занимать изображение скважин, пластов земли и газоводяного контакта. Элементы управления должны занимать лишь небольшую часть экрана. Для отображения скважин были показаны преимущества кривой Безье по сравнению с линейным сплайном и интерполирующим многочленом Лагранжа. В ходе разработке метода отображения пластов земли и газоводяного контакта было выяснено, что для построения полигональной сетки не достаточно только значений измеренных координат. Для получения массива треугольников, который задает порядок вершин, в статье предложен метод триангуляции Делоне. Для обеспечения кроссплатформенности приложения в работе предлагается использовать платформу для 3D разработки Unity 3D совместно с технологией IL2CPP и кросс-компилятором Emscripten, благодаря которым программа на языке C# преобразуется в язык WebAssembly.

В дальнейшем следует модернизировать анализ скважин и пластов земли и газоводяного контакта. Диспетчеру помимо анализа отклонения скважин от оси аппликат, длины, глубины в определенной точке необходимо также предоставить возможность исследования различных повреждений поверхности скважин. Для пластов земли и газоводяного контакта в дальнейшем необходимо также выводить информацию об изменениях состояния по сравнению с предыдущими замерами.
# Список литературы
1. Система расчета и визуализации данных для бурения скважин  URL: http://antereal.com/files/Whitepaper-RVDBS.pdf
2. Программное обеспечение для геологоразведки GeoSoft Target URL: https://www.geosoft.com/media/uploads/resources/brochures/tar_b_2011_09_ru_web.pdf
3. Программный комплекс для обработки СО, СГК, АИНК LogPWin-AIMS URL: http://www.karotazh.ru/ru/instruments/logpwinaims
4. PRIME URL: http://www.primegeo.ru/assets/files/prime_2019.pdf
5. Просмотрщик данных ГИС на WEB платформе: ПК «ML PRIME» URL: http://www.primegeo.ru/assets/files/WEB_viewer_ML-Prime.pdf
6. ИНСТРУМЕНТ ДЛЯ ВИЗУАЛИЗАЦИИ ПЛАНА БУРЕНИЯ OPTIMINE® URL: https://www.rocktechnology.sandvik/ru/%D0%BF%D1%80%D0%BE%D0%B4%D1%83%D0%BA%D1%86%D0%B8%D1%8F/%D0%B0%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F/%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D0%B5%D0%B9-optimine/%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82-%D0%B4%D0%BB%D1%8F-%D0%B2%D0%B8%D0%B7%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8-%D0%BF%D0%BB%D0%B0%D0%BD%D0%B0-%D0%B1%D1%83%D1%80%D0%B5%D0%BD%D0%B8%D1%8F-optimine/
7. В.А. Тараник ПРИМЕНЕНИЕ «ИНТЕРПОЛЯЦИОННОГО МНОГОЧЛЕНА ЛАГРАНЖА» ДЛЯ
ФУНКЦИЙ СО МНОГИМИ ПЕРЕМЕННЫМИ URL: https://vk.com/doc96151243_527102987?hash=ff252e97ebd1a1126c&dl=3fe4597582c6b2222e
8. В. В. Борисенко Построение оптимального сплайна Безье URL:  http://mech.math.msu.su/~fpm/ps/k16/k163/k16304.pdf
9.  Е.Ю. Бутырский,  К.И. Понкратова, В.В. Васильев Линейная сплайн-интерполяция в задаче обнаружения сигналов URL: https://www.infokosmo.ru/file/article/16555.pdf
10. В.А. Клячин, А.А. Широкий ТРИАНГУЛЯЦИЯ ДЕЛОНЕ МНОГОМЕРНЫХ
ПОВЕРХНОСТЕЙ URL:  https://cyberleninka.ru/article/n/triangulyatsiya-delone-mnogomernyh-poverhnostey/viewer
11. Поддержка WebAsslembly различнимыми браузерами URL: https://caniuse.com/#feat=wasm
12.  C.И.Клевцов ПРОБЛЕМЫ ПОСТРОЕНИЯ И СОВРЕМЕННЫЕ ТРЕБОВАНИЯ К ИНТЕРФЕЙСУ ПОЛЬЗОВАТЕЛЯ В ИНФОРМАЦИОННЫХ СИСТЕМАХ URL: https://cyberleninka.ru/article/n/problemy-postroeniya-i-sovremennye-trebovaniya-k-interfeysu-polzovatelya-v-informatsionnyh-sistemah
13. Unity WebGL URL: https://docs.unity3d.com/Manual/webgl-gettingstarted.html
