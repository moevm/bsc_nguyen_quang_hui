# Разработка ПО для конфигурирования микроконтроллеров, применяемых для управления работой уличных светофоров
Ключевые слова: светофор, разработка, ПЛК, конфигурирование, Modbus



## Аннотация
В данной статье рассмотрены способы конфигурирования программируемых логических контроллеров, которые используются для управления светофорами. Составлен краткий обзор существующих решений в этой сфере, проанализированы сильные и слабые стороны каждого решения в плане надежности. Оказалось, что на надежность влияет тот фактор, что при обновлении конфигурации перепрошивка контроллера не осуществляется. Это значительно уменьшает риск сбоя контроллера (например, из-за потери связи в процессе записи в его память).

Исходя из сделанных после обзора выводов, была разработана архитектура приложения, позволяющая выполнять конфигурирование контроллера без его перепрошивки. На ее основе было разработано приложение, позволяющее создавать и редактировать конфигурации и записывать (и считывать) их в память контроллера или в текстовый файл в формате XML. Разработанное решение обладает понятным пользователю, который не является специалистом в этой области, графическим интерфейсом и совместимо со всеми программируемыми логическими контроллерами, поддерживающими интерфейс Modbus и обладающими интерфейсом последовательного ввода-вывода. Приложение работает на операционных системах Microsoft Windows и Apple macOS и нетребовательно к вычислительным ресурсам устройства, на котором оно запущено.



## Введение
В настоящее время одну из важных ролей в больших городах играет проблема дорожного трафика. Пропускная способность городских улиц в наибольшей степени зависит от светофоров. Для обеспечения максимального потока автомобилей через перекрестки необходимо реагировать на изменение времени суток и других факторов, влияющих на дорожное движение. Более того, иногда требуется быстрая реакция на резко изменяющиеся дорожные условия (например, ремонт дороги). 

Одним из основных аспектов работы светофора является способ программирования контроллера, управляющего им. От скорости и удобства передачи инструкций светофору зависит скорость реакции на изменение дорожной обстановки, количество персонала, осуществляющего его  обслуживание, их квалификация. В таком случае, замедленная реакция может привести к путанице на дороге, которая может спровоцировать опасные ситуации.

В настоящее время не существует бесплатного специализированного ПО, позволяющего быстро и удобно производить программирование и отладку в программируемые логические контроллеры (далее - ПЛК), управляющих поведением светофоров. 

Целью статьи является разработка приложения для конфигурирования ПЛК, предназначенных для управления работой уличных светофоров. Под конфигурацией понимается набор численных значений, отвечающих за различные аспекты работы светофора (например, время горения красного и зеленого сигналов, время мигания желтого сигнала, расписание переключения режимов).

Задачи исследования:

* составить обзор существующих решений;
* разработать архитектуру, обеспечивающую работу с различными типами ПЛК;
* реализовать систему хранения конфигурации в текстовом формате (XML);
* разработать метод конфигурирования контроллера;
* разработать кроссплатформенное приложение.



## Обзор предметной области
Из-за наличия большой конкуренции в области исследования, большая часть готовых решений находится в закрытом доступе. Исходя из этого, в качестве аналогов будет рассматриваться не только само ПО, но также другие возможные способы решения проблемы конфигурирования светофоров.


### Управление с помощью контроллера SIEMENS S7-300
Для достижения поставленной задачи применяется модульный контроллер Siemens SIMATIC S7-300 [1]. Для организации работы по конфигурированию, программированию и тестированию программной части решения служит утилита SIMATIC STEP 7. При помощи нее создается программа для контроллера на языке функциональных блочных диаграмм (FBD). Программу необходимо модифицировать всякий раз, когда изменяется сценарий работы светофора.


### Приложение ATSUI
Пользовательский интерфейс приложения ATSUI [2] обеспечивает дружественную пользователю среду, которая делает опрос состояния контроллера и функциональных возможностей, таких как время и производительность детектора, легкой задачей, поскольку доступ ко всем этим функциям можно просматривать как в графическом, так и в числовом форматах. Предназначен для контроллеров фирмы ATC. Работает на операционной системе Microsoft Windows.


### Приложение для планирования трафика LISA+
Программная система производства SCHLOTHAUER & WAUER [3], предназначенная для анализа перекрестков, тестирования механизмов управления трафиком, симуляции потока автомобилей, а также конфигурирования контроллеров множества производителей светофоров.


### Контроллер Siemens Sitraffic sX
Специализированный контроллер  для управления трафиком [4]. Способен осуществлять конфигурирование, а также сбор информации с сенсоров. Для облегчения настройки применяется ПО Sitraffic smartCore, обладающее графическим интерфейсом.


### Управление при помощи Веб-приложения
Решение подразумевает использование контроллера, который управляется сервером с открытым исходным кодом через веб-приложение [5]. Таким образом достигается охват различных устройств.


### Критерии сравнения аналогов

#### Способ конфигурирования
Показывает, каким образом составляется программа для работы светофора. Способ конфигурирования определяет, какие инструменты даются человеку, чтобы создать конфигурацию (или изменить существующую) контроллера и записать ее в контроллер. Это может быть либо программирование контроллера вручную, либо использование графического интерфейса. 

#### Совместимость
Показывает, с какими моделями контроллеров может работать решение. Указывается название фирмы производителя, серия и название контроллера.

#### Необходимость перепрошивки контроллера
Указывает необходимость перепрошивки контроллера при обновлении конфигурации. От критерия зависит надежность решения, т.к. процесс перепрошивки контроллера - это процесс, который может занять долгое время, и в процессе которого возможно возникновение ошибок, приводящих в итоге даже к выходу его из строя. Если перепрошивка необходима, указывается "+", иначе "-".


### Сравнение аналогов
По приведенным критериям было проведено сравнение аналогов (см. табл. 1).

Таблица 1. Сравнение аналогов по критериям.

|                           |    Способ конфигурирования   |     Совместимость    | Необходимость перепрошивки контроллера | 
| ------------------------- | ---------------------------- | -------------------- | -------------------------------------- |
| Контроллер SIEMENS S7-300 | программирование контроллера |    SIEMENS S7-300    |                   +                    |
| ATSUI©                    |     графический интерфейс    |        ATC ATSC4     |                   -                    |
| LISA+                     |     графический интерфейс    |       не известно    |                   -                    |
| Siemens Sitraffic sX      |     графический интерфейс    | Siemens Sitraffic sX |                   -                    |
| Веб-приложение            |         веб-интерфейс        |        Panasonic     |                   -                    |


Все рассмотренные аналоги обладают возможностью настройки времени горения сигналов светофора, включения зеленого мигающего света. Также, все решения, кроме первого и последнего, поддерживают задание расписания и отладку контроллеров в реальном времени.

На надежность решения в наибольшей степени влияют два из трех предложенных критериев: *Способ конфигурирования* и *Необходимость перепрошивки контроллера*.  При наличии удобного для человека способа конфигурации контроллера минимизируется риск человеческой ошибки. А нужда перепрошивки контроллера при каждом изменении конфигурации увеличивает вероятность сбоя. 

По итогам проведенного сравнения было выяснено, что наименее надежным решением из предложенного является использование контроллера SIEMENS S7-300 [1] с программированием его вручную.

Кроме того, все программные системы в сравнении не являются бесплатными, следовательно, в рамках статьи невозможно экспериментально оценить их работоспособность.



## Выбор метода решения
Решение должно представлять собой программный продукт, который может эксплуатироваться не только квалифицированными работниками, но и пользователями, не являющимися специалистами в рассматриваемой области. Для этого продукт обязан предоставлять пользователю удобный графический интерфейс. Решение должно обладать следующими качествами:

 * **Скорость работы**. Приложение должно быстро запускаться (не более 3 секунд), а графический интерфейс должен моментально реагировать на действия пользователя.
 * **Легковесность**. Приложение должно занимать малое количество памяти как на жестком диске (не больше 50МБ), так и в оперативной памяти (не больше 100МБ).
 * **Кроссплатформенность**. Приложение должно быть доступно для нескольких популярных операционных систем (Windows, macOS).
 * **Бесплатность**. Приложение должно распространяться бесплатно.
 * **Надежность**. Программа не должна аварийно завершаться в процессе работы, а также минимизировать риск ошибок в процессе записи конфигурации в контроллер.
 * **Функциональность**. Программа должна предоставлять базовые возможности по настройке режимов работы светофора и расписания, уметь выполнять отладку в режиме реального времени.
 * **Универсальность**. Программа должна иметь возможность конфигурирования не только контроллеров для светофоров, но также вспомогательных элементов (например, табло отсчета времени).

 Первые три качества необходимы для снижения системных требований программы к устройству, на котором она запускается, и расширения списка этих устройств за счет поддержки множества платформ.



## Описание метода решения
Для обеспечения кроссплатформенности и поддержки низкоуровневого ввода-вывода (для связи с контроллерами) используется инструментарий Qt и язык программирования C++.

Для связи с контроллером используется протокол Modbus — открытый коммуникационный протокол, основанный на архитектуре ведущий-ведомый (master-slave). Он широко применяется в промышленности для организации связи между электронными устройствами.

В качестве целевого контроллера может использоваться любой ПЛК, поддерживающий интерфейс Modbus и обладающий интерфейсом последовательного ввода-вывода, программа которого считывает из собственной памяти данные, получая таким образом параметры конфигурации. Готовое решение должно лишь обеспечивать запись конфигурации в регистры контроллера, предоставляя структурированный графический интерфейс, понятный пользователю. Таким образом, отпадает необходимость в перепрошивке контроллера для изменения конфигурации.

Приложение состоит из нескольких основных частей:

* классы для каждого типа поддерживаемых контроллеров;
* библиотека, отвечающая за работу с контроллерами по протоколу Modbus;
* классы графического интерфейса. 

Диаграмма взаимодействия компонентов в решении изображена на рис. 1. 

![Диаграмма взаимодействия компонентов решения](paper-diag1.png)

<center>Рисунок 1. Диаграмма взаимодействия компонентов решения.</center>

Серым цветом отмечены компоненты, с которыми работает приложение, описанное в статье. Стрелками показаны направления потоков данных.

### Классы для поддерживаемых контроллеров
Классы для поддерживаемых контроллеров (далее - проекты) хранят конфигурацию контроллера, а так же, зная адреса управляющих регистров, обеспечивают запись и считывание конфигурации из контроллера. Каждый разработанный класс имеет возможность сохранения этой конфигурации в текстовый файл в формате XML и возможность восстановления конфигурации из файла. Таким образом, пользователь программы сможет хранить различные конфигурации в виде текстовых файлов, и, при желании, быстро между ними переключаться.

Для обеспечения такой функциональности используется структура классов во главе с интерфейсом, задающим методы для получения типа используемого контроллера, сброса конфигурации до состояния по умолчанию, записи и чтения конфигурации в текстовый файл и в контроллер (см. рис. 2).

![Примерная структура классов проекта](paper-uml1.png)

<center>Рисунок 2. Примерная диаграмма классов проектов.</center>

Классы, реализующие интерфейс _Project_, содержат методы для получения значений элементов управления (переключателей, полей ввода, и т.д.), а также их установки. Каждый конкретный класс проекта отвечает только за работу с определенным контроллером. 

В момент подключения контроллера к программе автоматически определяется его тип, на основе которого создается конкретный проект. Далее, из контроллера считывается конфигурация и пользователю показываются доступные элементы для ее редактирования.


### Классы графического интерфейса
Программа имеет меню верхнего уровня с вкладками. Каждая вкладка является страницей с элементами управления. Пользователю показываются только те страницы контроллера, с которым он работает в данный момент. Такой подход позволяет исключить использование вложенных меню или диалоговых окон, облегчая навигацию по приложению. Разбиение на части также упрощает добавление поддержки нового типа контроллеров во время разработки.

При запуске программы открывается страница с параметрами подключения. После этого пользователь может:

* Подключить контроллер и автоматически считать его конфигурацию;
* Открыть проект с жесткого диска компьютера;
* Создать новый проект для любого типа поддерживаемых контроллеров.

На рис. 3 для примера изображена вкладка настройки ключей светофора. 

![Скриншот разработанного приложения](paper-screen1.png)

<center>Рисунок 3. Скриншот разработанного приложения.</center>

Каждому ключу соответствует один выход и одна лампа светофора. На экране задается тип ключа и его цвет для упрощения последующей идентификации ключей при составлении расписания.


## Испытания разработанного решения
Были проведены испытания разработанного решения на соответствия требованиям, выдвинутым в разделе _Выбор метода решения_. 

Испытания проводились на следующей конфигурации оборудования:

* Процессор: 2,3 GHz Intel Core i5
* Память: 8 GB 2133 MHz LPDDR3
* ОС: macOS 10.14.1 (Mojave)

В результате испытаний было установлено:

* запуск приложения занял около **0.2 секунды**;
* размер исполняемого файла на жестком диске составляет **23.9 МБ**;
* занимаемое место в оперативной памяти при открытом проекте составляет **47 МБ**, без открытого проекта - **27 МБ**.

Полученные результаты полностью соответствуют поставленным требованиям.



## Заключение
В ходе данного исследования был составлен обзор существующих решений, предназначенных для конфигурирования светофоров, проанализированы их сильные и слабые стороны. Основными требованиями были выделены надежность и удобство графического интерфейса.

Было разработано архитектурное решение, основанное на возможности использования любых ПЛК. Оно позволяет уменьшить риск возникновения ошибок, исключив необходимость прошивки контроллера. Это достигается благодаря тому, что программа записывает конфигурацию в память контроллера в виде числовых и битовых данных. Для связи с контроллером используется сетевой протокол Modbus.

На основе разработанной архитектуры было разработано кроссплатформенное приложение, которое поддерживает запись конфигурации не только напрямую в контроллер, но также на жесткий диск компьютера в виде текстового файла в формате XML. В приложении сделан акцент на простоту навигации по графическому интерфейсу за счет использования вкладок.

Приложение было испытано на реальном устройстве и показало себя нетребовательным к вычислительным ресурсам.

Дальнейшими планами развития является создание сборки для операционной системы Ubuntu Linux.



## Список литературы
1. Лай Чунг Тиен, Чан Ван Нам
    УПРАВЛЕНИЕ СВЕТОФОРАМИ С ПОМОЩЬЮ КОТРОЛЛЕРА SIEMENS S7-300 // VII Всероссийская конференция «Научная инициатива иностранных студентов и аспирантов российских вузов». 

2. ATSUI Graphical User Interface to Controller 
    URL: http://www.aldridgetrafficcontrollers.com.au/Products/ATSUI-Graphical-User-Interface/ATSUI 
	
3. Traffic engineer’s perfect assistant 
    URL: https://www.schlothauer.de/en/software-systems/lisa/ 
	
4. The Sitraffic sX traffic controller 
    URL: https://www.siemens.com/content/dam/webassetpool/mam/tag-siemens-com/smdb/mobility/road/traffic-management/on-the-road/controller/documents/smart-traffic-starts-with-a-smart-x-en.pdf

5. VERICA ALEKSOVSKA, ALBENA TANEVA, IVAN GANCHEV
    TRAFFIC LIGHTS CONTROL VIA WEB APPLICATION // Journal of the Technical University – Sofia Plovdiv branch, Bulgaria. 2015. №21.