## Разработка подхода к созданию системы мониторинга и восстановления работоспособности виртуальных машин, развернутых Proxmox
Ключевые слова: Proxmox, система мониторинга, виртуальные машины, Proxmox API
### Аннотация

Целью статьи является разработка подхода к созданию системы, обеспечивающей работоспособность виртуальных машин в кластерах Proxmox для НИЦ СПб ЭТУ. В данной статье рассмотрены причины необходимости создания такой системы, выполнен сравнительный анализ существующих систем мониторинга и их возможностей по восстановлению работоспособности виртуальных машин, развернутых на Proxmox. При сравнительном анализе систем выявлены их недостатки, далее, выделены основные функциональные требования для системы, реализация которых позволила бы устранить проблемы, которые возникли при работе Proxmox c виртуальными машинами на операционных системах MCBC и Astra Linux.

### Введение

Ручной мониторинг и восстановление виртуальных машин сильно нагружает системных администраторов, что замедляет время восстановления виртуальных машин и может снизить скорость выполнения задач. Автоматизация мониторинга и восстановления виртуальных машин позволит снизить нагрузку на системных администраторов и обеспечит быстрое восстановление
виртуальных машин. Существующие системы мониторинга позволяют решить вышеуказанную проблему, однако часто требуют установки агентов на виртуальные машины, что не всегда возможно, например, для операционных систем MCBC и Astra Linux. Более того, иногда это запрещено политикой безопасности компаний. В статье ставится задачи проведения сравнительного анализа существующих систем, выявления их недостатков, а так же создание системы и функциональных характеристик, позволяющей восстанавливать работоспособность виртуальных машин, при этом не использующей агентов и удаленного SSH-соединения.

###  Обзор существующих аналогов и выбор метода решения

﻿#### Принцип отбора аналогов

Отбор аналогов производился согласно требованиям к системе, необходимой для НИЦ СПб ЭТУ. В частности:

- Возможность удаленного восстановления работоспособности виртуальных машин без использования SSH и установку агентов на машины
- Возможность работы под разными операционными системами (кроссплатформенность)

В таблице приведено сравнение существующих систем мониторинга. 

**PRTG Network Monitor** [6] - проприетарная безагентая система мониторинга, обеспечивающий сбор информации через множество протоколов таких как  SNMP, Netflow о потоках данных проходящих через определенные устройства, обеспечивает просмотр статистики в виде графиков и таблиц, а так же показывает статистику переданных пакетов. Запускается только на Windows.

**SolarWinds** [1] - система мониторинга имеющая гибкий и интуитивно понятный новому пользователю интерфейс, а так же благодаря Advanced Alert Manager обеспечивает  возможность настройки оповещений, как ответ на соответствующие события. Однако, не позволяет автоматически создавать топологию сети во время процесса обнаружения машин и только частично поддерживает возможность безагентого сбора данных. Доступен только на Windows.

**Zabbix** [4]  - решение для мониторинга различных параметров сети. В Zabbix присутствует настройка уведомлений, которая позволяет пользователю настроить отправку уведомлений на почту или пуш-уведомления на телефон. Zabbix имеет возможность восстанавливать работоспособность недоступных систем, используя агентов. Кроме того система предлагает подробные возможности по визуализации данных основанные на данных истории. Хотя данная система поддерживает возможность работы в режиме Agentless, возможности системы сильно уменьшаются.

**OpenNMS** [7] -  Open Source система мониторинга внутренних систем сетевого и серверного оборудования. Поддерживается работа без агентов, а для сбора информации используются сборщики, которые работают по SNMP, HTTP, ИТДИТП протоколам. Настройка обеспечивается как с помощью веб-интерфейса так и изменением XML файлов. 

**FreeNATS** [8] - система мониторинга, позволяющая производить мониторинг с помощью SMTP, POP3 HTTP, ICMP протоколов с возможностью настройки уведомлений [3]. Не поддерживает безагентный сбор данных, а автоматическое обнаружение устройств сети возможно только с помощью плагина.

На основе вышеуказанных требований, в качестве **критериев сравнения** были выбраны:

1. **Кроссплатформенность** - позволяет увеличить количество пользователей системой
2. **Безагентный сбор данных** - возможность производить мониторинг систем, на которых по различным причинам невозможна установка агентов
3. **Возможность восстановления работоспособности **  - наличие опции восстановления виртуальных машин, например после зависания путем перезагрузки. Под работоспособностью подразумевается возможность обращения к определенному порту виртуальной машины.

Таблица

|                                              | PRTG                   |              SolarWinds              | Zabbix                                                       | OpenNMS  | FreeNATS |
| -------------------------------------------- | ---------------------- | :----------------------------------: | ------------------------------------------------------------ | -------- | -------- |
| Кроссплатформенность                         | Нет                    |                 Нет                  | Да                                                           | Да       | Да       |
| Безагентный сбор данных                      | Да                     |                  Да                  | Поддерживается (агент может быть использован, но не обязательно) | Частично | Нет      |
| Возможность восстановления работоспособности | Да (SSH Script Sensor) | Ограниченно(Только Windows 7 и выше) | Да (Требует установки агента)                                | Нет      | Нет      |

####  Выводы по итогам сравнения

Как видно, SolarWinds и PRTG Network Monitor поддерживают безагентный мониторинг, однако не являются кроссплатформенными, в то время как Zabbix, OpenNMS и FreeNATS являются, однако если и поддерживают безагентную работу, то их функционал сильно ограничивается.

Необходимым свойством восстановления работоспособности машин обладают Zabbix, SolarWinds и PRTG. Zabbix имеет такую возможность только при наличии установленных на машине агентов [4], что невозможно в системах MCBC и Astra Linux. PRTG требует использования SSH [5], что сильно усложняет управление большим числом виртуальных машин, поскольку это требовало бы хранения паролей и ключей для каждой машины. Что касается SolarWinds, этот продукт не поддерживает работу с UNIX системами.

### Выбор метода решения

Выбор решения основан на двух факторах:

1) НИЦ СПб ЭТУ, для которого необходима данная система, использует в качестве операционных систем  для виртуальных машин MCBC и Astra Linux. На таких системах установка агентов невозможна, в связи с этим, необходим подход не использующий агентов.

2) Поскольку в текущей сети используется большое количество виртуальных машин (более 500), использование SSH может сильно затруднить работу с ними, поскольку это требовало бы запоминания всех паролей или ключей, которые, более того, могут часто меняться.

В результате сравнения аналогов и учитывая вышеуказанные ограничения, было показано, что недостатки существующих систем, такие как отсутствие возможности безагентного мониторинга и использование удаленного SSH-соединения не оставляют возможности их использования в качестве системы восстановления работоспособности для сети НИЦ СПб ЭТУ.

Исходя из этого, в системе было решено использовать API Proxmox [2], который не поддерживается ни одной из рассмотренных систем, поскольку API позволило бы восстанавливать работоспособность, без участия самих систем виртуальных машин.

### Описание метода решения

Решение должно представлять собой программный продукт, работающий в системе Proxmox VE v5.2 и выше, предоставляющий возможность мониторинга без установки агентов и использования удаленного соединения по SSH.

 Решение должно соответствовать следующим функциональным требованиям:

- Программа исполняется в терминале, в качестве фонового процесса, по причине экономии ресурсов и во избежание избыточности функционала
- Система должна автоматически, раз в 60 секунд (такое время выбрано в целях экономии трафика), поочередно проверять машины в кластере на доступность  в сети и работоспособность.  Если система недоступна в сети, значит она вышла из строя. Если система не доступна по портам, которые можно задать дополнительно, значит она неработоспособна.
- Проверка должна осуществляться путем опроса всех виртуальных машин в кластере с хост-машины по ICMP, а портов по TCP используя стандартные linux-команды, поскольку данные протоколы обеспечивают возможность удаленного сбора необходимых данных.
- В случае выхода определенной машины из строя система должна ее перезагрузить и проверить на доступность. В случае если машина остается недоступной, отправить на уведомление, содержащее данные о машине, на указанную при настройке системы почту.
- Использование любых методов, требующих ввода логина и пароля виртуальной машины запрещено. Обусловлено отсутствием данной информации и возможности смены этих данных.

Уведомление содержит следующие данные о вышедшей из строя виртуальной машине:

1. Имя машины

1. ID машины

1. MAC адрес машины

1. IP адрес машины

1. Время выхода из строя (текущее время)

1. Дополнительная информация (имя нерабочего интерфейса или порта)

Для имитации неработоспособности виртуальных машин необходимо разработать **сценарии выхода из строя**.

#### Сценарии выхода из строя

- Отключение от сети одной из виртуальных машин

- Отключение доступности определенных портов

Данные ситуации могут возникнуть в том случает если программа “Не отвечает”, либо произошел сбой в операционной системе либо настройках сетевого интерфейса.

Для имитации выхода из строя необходимо создать скрипт, который будет случайно выключать и включать интерфейсы, а так же блокировать соединения по назначенным портам.

**Принцип работы:**
С хост-компьютера исполняется скрипт (планируется использование ansible [9]), который:

1) Случайно формирует массив true/false элементов, длина которого равна количеству виртуальных машин
2) Удаленно создает несколько SSH соединений, посылая команду 
ifconfig <interface> down
ifconfig <interface> up 
которая включает или выключает интерфейс (имитируется неработоспособность), либо порт (оба определяются элементом сформированного массива).
3) Повторяет действия 1 и 2 раз в 60 секунд.

### Заключение 

В рамках данного исследования проведен сравнительный анализ существующих систем мониторинга по следующим критериям: кроссплатформенность, возможность безагентного сбора данных и возможность восстановления работоспособности. 

По результатам сравнения сделан вывод:

- О недостатках рассмотренных решений (у рассмотренных систем нет возможности восстанавливать работоспособность и при этом не использовать SSH-соединение)
- О необходимости разработки новой системы, основанной на использовании API Proxmox, использование которой не требовало бы установки агентов и использования паролей при удаленном соединении. 

Выделены функциональные требования, основа которых  - взаимодействие с виртуальными машинами при мониторинге  - через протоколы TCP/ICMP, при восстановлении работоспособности - используя API Proxmox.

Разработаны сценарии выхода из строя, такие как отключение от сети виртуальных машин и доступности их портов. Результаты данной работы будут использованы при создании системы мониторинга для НИЦ СПб ЭТУ, устраняющей обнаруженные недостатки. 

Направления дальнейших исследований включают в себя апробирование разработанной системы на инфраструктуре предприятия НИЦ СПб ЭТУ на 5 серверах Proxmox, объединенных в один кластер с более чем 500 виртуальных машин, экспериментальную оценку расхода трафика сети системой, и последующую оптимизацию системы, в целях уменьшения расходов трафика сети.  

### Список литературы

1. NPM 12.0 system requirements - SolarWinds Worldwide, LLC. Help and Support [Электронный ресурс]. URL: https://support.solarwinds.com/Success_Center/Network_Performance_Monitor_(NPM)/NPM_Documentation/Previous_Versions/NPM_12-0_system_requirements (дата обращения: 01.10.2018). 
2. Proxmox VE API Documentation [Электронный ресурс]. URL: <https://pve.proxmox.com/pve-docs/api-viewer/index.html>
3. Alerts FreeNATS Documentation [Электронный ресурс]. URL: http://www.purplepixie.org/freenats/wiki/Alerts (дата обращения: 17.12.2018).
4. Triggers Zabbix Documentation 3.0. URL:  https://www.zabbix.com/documentation/3.0/manual/config/triggers>. (дата обращения: 12.12.2018).
5. Notifications | PRTG Network Monitor User Manual [Электронный ресурс]. URL: https://www.paessler.com/manuals/prtg/notifications  (дата обращения: 12.10.2018).
6. PRTG Network Monitor User Manual [Электронный ресурс]. URL: https://www.paessler.com/manuals/prtg/ (дата обращения: 12.10.2018).
7. What is OpenNMS - OpenNMS [Электронный ресурс]. URL: https://wiki.opennms.org/wiki/What_is_OpenNMS (дата обращения: 18.12.2018).
8. Introduction - FreeNATS Wiki [Электронный ресурс]. URL: http://www.purplepixie.org/freenats/wiki/Introduction (дата обращения: 18.12.2018).
9. How Ansible Works | Ansible.com [Электронный ресурс]. URL: https://www.ansible.com/overview/how-ansible-works (дата обращения: 18.12.2018).